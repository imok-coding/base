import{r as c,j as e}from"./index-BwO8d8jG.js";const k="https://steam-worker.imokissick.workers.dev";function E(){const[a,t]=c.useState(null),[y,m]=c.useState(!0),[n,p]=c.useState(""),[h,f]=c.useState(""),[r,u]=c.useState(0),[l,v]=c.useState("recent"),[j,_]=c.useState({}),[g,N]=c.useState({});c.useEffect(()=>{let s=!1;return(async()=>{try{p(""),m(!0);const i=await fetch(`${k}/steam/owned-games`);if(!i.ok)throw new Error("Unable to load Steam games");const d=await i.json();if(s)return;t(d||null)}catch(i){s||p(i.message||"Steam games unavailable")}finally{s||m(!1)}})(),()=>{s=!0}},[]);const b=c.useMemo(()=>{if(!(a!=null&&a.games))return[];const s=h.toLowerCase(),o=Number(r)||0,i={recent:(d,x)=>(x.rtime_last_played||0)-(d.rtime_last_played||0),name:(d,x)=>d.name.localeCompare(x.name),hours:(d,x)=>(x.playtime_forever||0)-(d.playtime_forever||0)};return[...a.games].filter(d=>{var x;return((x=d.name)==null?void 0:x.toLowerCase().includes(s))&&(d.playtime_forever||0)/60>=o}).sort(i[l]||i.recent).slice(0,60)},[a,h,r,l]),w=c.useCallback(async s=>{if(!(!s||j[s]||g[s])){N(o=>({...o,[s]:!0}));try{const o=await fetch(`${k}/steam/achievements?appid=${s}`);if(!o.ok)throw new Error("Unable to load achievements");const i=await o.json();_(d=>({...d,[s]:i}))}catch(o){_(i=>({...i,[s]:{error:o.message||"No achievements found"}}))}finally{N(o=>{const i={...o};return delete i[s],i})}}},[j,g]);return y?e.jsx("div",{className:"steam-panel",children:"Loading library..."}):n?e.jsx("div",{className:"steam-panel",children:n}):a?e.jsxs("div",{className:"steam-panel steam-games",children:[e.jsxs("header",{className:"steam-games__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Library"}),e.jsx("h3",{children:"Game filtering & achievements"})]}),e.jsxs("div",{className:"steam-filters",children:[e.jsx("input",{value:h,onChange:s=>f(s.target.value),placeholder:"Search games..."}),e.jsxs("label",{children:["Min hours",e.jsx("input",{type:"number",min:"0",value:r,onChange:s=>u(s.target.value)})]}),e.jsxs("label",{children:["Sort by",e.jsxs("select",{value:l,onChange:s=>v(s.target.value),children:[e.jsx("option",{value:"recent",children:"Recently played"}),e.jsx("option",{value:"hours",children:"Hours played"}),e.jsx("option",{value:"name",children:"Name"})]})]})]})]}),e.jsx(L,{owned:a}),e.jsxs("section",{className:"steam-section library-list",children:[b.map(s=>e.jsx($,{game:s,achievement:j[s.appid],loading:!!g[s.appid],requestAchievements:w},s.appid)),b.length===0&&e.jsx("p",{className:"subtext",children:"No games match this search."})]}),e.jsx(S,{owned:a})]}):null}function S({owned:a}){const t=a.games.reduce((y,m)=>y+m.playtime_forever,0)/60;return e.jsxs("div",{className:"totals",children:[e.jsxs("div",{children:[a.game_count," games"]}),e.jsxs("div",{children:[t.toFixed(0)," hrs played"]})]})}function $({game:a,achievement:t,loading:y,requestAchievements:m}){var N,b,w;c.useEffect(()=>{m(a.appid)},[a.appid,m]);const n=((a.playtime_forever||0)/60).toFixed(0),p=a.playtime_2weeks?(a.playtime_2weeks/60).toFixed(1):null,h=a.rtime_last_played||a.last_playtime||a.last_played||a.last_played_time||a.last_played_on||null,f=h?new Date(Number(h)*1e3).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}):"Never",r=(t==null?void 0:t.achievements)||((N=t==null?void 0:t.playerstats)==null?void 0:N.achievements)||[],u=r.filter(s=>s.achieved).length,l=r.length||0,v=l?Math.round(u/l*100):0,j=r.filter(s=>s.achieved&&s.icon).slice(0,5).map(s=>s.icon),_=(t==null?void 0:t.error)||(((b=t==null?void 0:t.playerstats)==null?void 0:b.success)===!1?((w=t==null?void 0:t.playerstats)==null?void 0:w.error)||"Unavailable":null),g=y||!t&&!_;return e.jsxs("div",{className:"library-row",children:[e.jsxs("div",{className:"library-row__main",children:[e.jsx("img",{src:`https://cdn.cloudflare.steamstatic.com/steam/apps/${a.appid}/header.jpg`,alt:a.name,loading:"lazy",onError:s=>{s.target.dataset.fallback||(s.target.dataset.fallback="1",s.target.src="https://via.placeholder.com/460x215?text=No+Image")}}),e.jsxs("div",{className:"library-row__meta",children:[e.jsx("div",{className:"library-row__title",children:e.jsx("strong",{children:a.name})}),e.jsxs("p",{className:"subtext",children:[p?`${p} hrs in 2 weeks - `:"","Last played on ",f]})]}),e.jsx("div",{className:"library-row__hours",children:e.jsxs("span",{className:"subtext",children:[n," hrs on record"]})})]}),e.jsxs("div",{className:"library-row__ach",children:[e.jsxs("div",{className:"library-row__ach-header",children:[e.jsx("span",{className:"subtext",children:"Achievement Progress"}),e.jsx("span",{className:"subtext",children:g?"Loading...":_||(l?`${u} of ${l}`:"No Achievements")})]}),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"achievements__progress slim",children:e.jsx("div",{className:"achievements__bar",style:{width:`${v}%`}})}),!_&&l>0&&e.jsxs("div",{className:"achievements__icons",children:[j.map((s,o)=>e.jsx("img",{src:s,alt:"Achievement icon"},`${a.appid}-icon-${o}`)),l>j.length&&e.jsxs("span",{className:"achievements__more",children:["+",Math.max(l-j.length,0)]})]})]})]})]})}function L({owned:a}){const t=c.useMemo(()=>{var f;if(!((f=a==null?void 0:a.games)!=null&&f.length))return[];const n=new Date,p=Array.from({length:6}).map((r,u)=>{const l=new Date(n.getFullYear(),n.getMonth()-(5-u),1);return{key:`${l.getFullYear()}-${l.getMonth()}`,label:l.toLocaleString("default",{month:"short"}),value:0}}),h=Object.fromEntries(p.map(r=>[r.key,r]));return a.games.forEach(r=>{if(!r.rtime_last_played)return;const u=new Date(r.rtime_last_played*1e3),l=`${u.getFullYear()}-${u.getMonth()}`;if(!h[l])return;const v=r.playtime_2weeks!=null?r.playtime_2weeks/60:r.playtime_forever?r.playtime_forever/60:0;h[l].value+=v}),p},[a]);if(!t.length)return null;const y=Math.max(...t.map(n=>n.value),0),m=t.some(n=>n.value>0);return e.jsxs("div",{className:"playtime-card",children:[e.jsxs("div",{className:"playtime-card__head",children:[e.jsx("p",{className:"eyebrow",children:"Graphs"}),e.jsx("h4",{children:"Playtime over time"}),e.jsx("p",{className:"subtext",children:m?"Hours by last-played month (approximate)":"No recent playtime data available."})]}),e.jsx("div",{className:"playtime-graph",children:t.map(n=>e.jsxs("div",{className:"playtime-graph__bar",children:[e.jsx("div",{className:"playtime-graph__fill",style:{height:m?`${Math.max(n.value/Math.max(y,1)*100,6)}%`:"6%"}}),e.jsx("span",{children:n.label})]},n.key))})]})}export{E as default};
